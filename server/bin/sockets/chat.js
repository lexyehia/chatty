"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const ws_1 = require("ws");
const uuid = require("uuid/v4");
function chatRoomChannel(wss) {
    //let userColours: IColourMap = {}
    const userColours = new Map();
    wss.broadcast = (data) => {
        wss.clients.forEach((client) => {
            if (client.readyState === ws_1.OPEN) {
                client.send(data);
            }
        });
    };
    wss.on('connection', (ws) => {
        assignUniqueColour(ws);
        broadcastUserCount();
        ws.on('message', (data) => processMessage(data, ws));
        ws.on('close', broadcastUserCount);
    });
    const processMessage = (json, socket) => {
        let message = JSON.parse(json);
        message.key = uuid();
        message.colour = userColours.get(socket._socket.remoteAddress);
        broadcastMessage(message);
    };
    const broadcastUserCount = () => {
        const clients = wss.clients.size;
        const message = {
            type: "count",
            content: clients.toString()
        };
        broadcastMessage(message);
    };
    const assignUniqueColour = (socket) => {
        const colours = ["00C5CD", "5959AB", "660000", "C48E48"];
        const i = Math.floor(Math.random() * 4);
        userColours.set(socket._socket.remoteAddress, colours[i]);
    };
    const broadcastMessage = (message) => {
        wss.broadcast(JSON.stringify(message));
    };
}
exports.chatRoomChannel = chatRoomChannel;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zb2NrZXRzL2NoYXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFDQSwyQkFBeUI7QUFDekIsZ0NBQStCO0FBRS9CLHlCQUFnQyxHQUFrQjtJQUU5QyxrQ0FBa0M7SUFDbEMsTUFBTSxXQUFXLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUE7SUFFbEQsR0FBRyxDQUFDLFNBQVMsR0FBRyxDQUFDLElBQVksRUFBUSxFQUFFO1FBQ25DLEdBQUcsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBVyxFQUFRLEVBQUU7WUFDdEMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVUsS0FBSyxTQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFBO1lBQ3JCLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUMsQ0FBQTtJQUVELEdBQUcsQ0FBQyxFQUFFLENBQUMsWUFBWSxFQUFFLENBQUMsRUFBRSxFQUFRLEVBQUU7UUFDOUIsa0JBQWtCLENBQUMsRUFBRSxDQUFDLENBQUE7UUFDdEIsa0JBQWtCLEVBQUUsQ0FBQTtRQUNwQixFQUFFLENBQUMsRUFBRSxDQUFDLFNBQVMsRUFBRSxDQUFDLElBQVksRUFBRSxFQUFFLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFBO1FBQzVELEVBQUUsQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLGtCQUFrQixDQUFDLENBQUE7SUFDdEMsQ0FBQyxDQUFDLENBQUE7SUFFRixNQUFNLGNBQWMsR0FBRyxDQUFDLElBQVksRUFBRSxNQUFXLEVBQUUsRUFBRTtRQUNqRCxJQUFJLE9BQU8sR0FBYSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQ3hDLE9BQU8sQ0FBQyxHQUFHLEdBQU0sSUFBSSxFQUFFLENBQUE7UUFDdkIsT0FBTyxDQUFDLE1BQU0sR0FBRyxXQUFXLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUE7UUFFOUQsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLENBQUE7SUFDN0IsQ0FBQyxDQUFBO0lBRUQsTUFBTSxrQkFBa0IsR0FBRyxHQUFTLEVBQUU7UUFDbEMsTUFBTSxPQUFPLEdBQVcsR0FBRyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUE7UUFDeEMsTUFBTSxPQUFPLEdBQWE7WUFDdEIsSUFBSSxFQUFNLE9BQU87WUFDakIsT0FBTyxFQUFHLE9BQU8sQ0FBQyxRQUFRLEVBQUU7U0FDL0IsQ0FBQTtRQUVELGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFBO0lBQzdCLENBQUMsQ0FBQTtJQUVELE1BQU0sa0JBQWtCLEdBQUcsQ0FBQyxNQUFXLEVBQVEsRUFBRTtRQUM3QyxNQUFNLE9BQU8sR0FBRyxDQUFDLFFBQVEsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFBO1FBQ3hELE1BQU0sQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFBO1FBRXZDLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7SUFDN0QsQ0FBQyxDQUFBO0lBRUQsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLE9BQWlCLEVBQVEsRUFBRTtRQUNqRCxHQUFHLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQTtJQUMxQyxDQUFDLENBQUE7QUFDTCxDQUFDO0FBaERELDBDQWdEQyJ9